<!DOCTYPE html>
<html lang="en">
<head>
  <title>Ethereum: offer your ether for bitcoin</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/dapp.css">
  <script src="./js/jquery-2.1.3.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <script src="./js/bignumber.js"></script>
  <script src="./js/web3.min.js"></script>

  <script src="./js/bs58check.js"></script>

  <script src="./js/ethBtcSwapAbi.js"></script>
  <script src="./js/shared.js"></script>

<script type="text/javascript">
var web3 = require('web3');
    web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));

var gWeiDeposit;


function lookup() {
  var ticketId = $('#ticketId').val();

  var ticketInfo = gContract.lookupTicket.call(ticketId);
  console.log('@@@ tinfo: ', ticketInfo);

  if (ticketInfo[0].eq(0)) {
    document.getElementById('result').innerText = 'Ticket has been claimed or does not exist'
    return;
  }

  var btcAddr = formatBtcAddr(ticketInfo[0]);
  var bnWei = ticketInfo[1];
  var bnWeiPerSatoshi = ticketInfo[2];
  var bnClaimExpiry = ticketInfo[3];
  var bnClaimer = ticketInfo[4];
  var bnClaimTxHash = ticketInfo[5];

  renderClaimer(bnClaimExpiry, bnClaimer, bnClaimTxHash);

  gWeiDeposit = bnWei.div(20);

  var bnEther = toEther(bnWei);
  var bnUnitPrice = toUnitPrice(bnWeiPerSatoshi);
  var bnTotalPrice = toTotalPrice(bnEther, bnUnitPrice);

  $('#btcAddr').text(btcAddr);
  $('#numEther').text(formatEtherAmount(bnEther));
  $('#totalPrice').text(formatTotalPrice(bnTotalPrice));

  $('#depositRequired').text(formatWeiToEther(gWeiDeposit));


  var txHash = $('#txHash').val();
  var urlJsonTx = "https://blockchain.info/rawtx/"+txHash+"?format=json&cors=true";
  $.getJSON(urlJsonTx, function(data) {
    console.log('@@@ rawtx data: ', data)

    if (!data || !data.out || data.out.length < 2) {
      console.log('@@@ err btc tx not enough outputs')
      return;
    }

    var bnSatoshi = web3.toBigNumber(data.out[0].value)
    $('#btcPayment').text(formatSatoshiToBTC(bnSatoshi));

    $('#paymentAddr').text(data.out[0].addr);

    // TODO check addr slice
    var tx1Script = data.out[1].script;
    var etherAddr;
    if (tx1Script && tx1Script.length === 50 &&
        tx1Script.slice(0, 6) === '76a914' && tx1Script.slice(-4) === '88ac') {
      etherAddr = data.out[1].script.slice(6, -4);
    }
    else {
      etherAddr = 'INVALID'
      console.log('@@ invalid ether addr: ', data.out[1])
    }
    $('#etherAddr').text(etherAddr);

    var bnWeiBuyable = bnWeiPerSatoshi.mul(bnSatoshi);
    // $('#weiBuyable').text(bnWeiBuyable.toString(10));

    var txQuality;
    var bnExtraWei = bnWeiBuyable.sub(bnWei);
    if (bnExtraWei.lt(0)) {
      txQuality = 'NO, transaction does not send enough bitcoin.'
    }
    else {
      txQuality = 'YES, transaction can claim the ethers in the ticket.'
    }
    $('#txQuality').text(txQuality);



    var bnEncodedFee = web3.toBigNumber(data.out[1].value).mod(10000);
    $('#encodedFee').text(bnEncodedFee.div(100).toString(10) + '%');

    var bnComputedFee = bnEncodedFee.mul(bnWei).div(10000);
    $('#computedFee').text(formatWeiToEther(bnComputedFee));
  });
}

function callContract() {
  // TODO ticket Abi
  console.log('@@@ in callContract')
  console.log('@@@ gFromAccount: ', gFromAccount)


  var callOnly;
  // callOnly = true;  // if commented, it will do sendTransaction

  var ticketId = parseInt($('#ticketId').val(), 10);
  var txHash = '0x' + $('#txHash').val();


  // TODO confirmation to deposit ether, from account, gasprice
  var objParam = {value: gWeiDeposit, from:gFromAccount, gas: 500000};

  if (callOnly) {
    console.log('@@@@ callOnly')
    var startTime = Date.now();


    var res = gContract.reserveTicket.call(ticketId, txHash, objParam);


    var endTime = Date.now();
    var durationSec = (endTime - startTime) / 1000;
    console.log('@@@@ call res: ', res, ' duration: ', durationSec)
    document.getElementById('result').innerText = res.toString(10) + "    " + durationSec+ "secs";
    return;
  }


  // var startTime = Date.now();



  var rvalFilter = gContract.ticketEvent({ ticketId: ticketId });
  rvalFilter.watch(function(err, res) {
    if (err) {
      console.log('@@@ rvalFilter err: ', err)
      return;
    }

    console.log('@@@ rvalFilter res: ', res)

    var eventArgs = res.args;
    if (eventArgs.rval.toNumber() === ticketId) {
      document.getElementById('result').innerText = 'SUCCESS Ticket has been reserved';
    }
    else {
      document.getElementById('result').innerText = 'Failed. Did you send enough deposit or specify correct ticket id?';
    }

    rvalFilter.stopWatching();
  });

  gContract.reserveTicket.sendTransaction(ticketId, txHash, objParam, function(err, txHash) {
    if (err) {
      console.log('@@@ reserveTicket sendtx err: ', err)
      return;
    }

    // result is a txhash
    console.log('@@@ reserveTicket txHash: ', txHash)
  });
  document.getElementById('result').innerText = 'Ethereum transaction is in progress...'
}

function writeClaimer(ticketId) {
  var ticketInfo = gContract.lookupTicket.call(ticketId);
  console.log('@@@ tinfo: ', ticketInfo);
  var bnClaimExpiry = ticketInfo[3];
  var bnClaimer = ticketInfo[4];
  var bnClaimTxHash = ticketInfo[5];

  renderClaimer(bnClaimExpiry, bnClaimer, bnClaimTxHash);
}

function renderClaimer(bnClaimExpiry, bnClaimer, bnClaimTxHash) {
  $('#claimExpiry').text(formatState(bnClaimExpiry));
  $('#claimerAddr').text(formatClaimer(bnClaimer));
  $('#claimTxHash').text(formatClaimTx(bnClaimTxHash));
}




function showTickets() {
  console.log('@@@ showTickets()')

  // TODO confirmation to deposit ether, from account, gasprice
  var objParam = {from:gFromAccount, gas: 500000};

  var ticketArr = gContract.getOpenTickets.call(1, 40, objParam);  // TODO may need objParam

  writeTable(ticketArr);
}


var TICKET_FIELDS = 7;
function writeTable(ticketArr) {
  var len = ticketArr.length;
  for (var i=0; i < len; i+= TICKET_FIELDS) {
    writeRow(ticketArr, i);
  }
}


function writeRow(ticketArr, index) {
  var ticketId = ticketArr[index + 0].toString(10);
  var bnBtcAddr = ticketArr[index + 1];
  var bnWei = ticketArr[index + 2];
  var bnWeiPerSatoshi = ticketArr[index + 3];

  var bnClaimExpiry = ticketArr[index + 4]
  // var bnClaimer = ticketArr[index + 5]
  // var bnClaimTxHash = ticketArr[index + 6]

  var tr = '<tr><td>{ticketId}</td><td>{numEther}</td><td>{unitPrice}</td>' +
    '<td>{totalPrice}</td><td>{btcAddr}</td><td>{claimExpiry}</td>' +
    // '<td>{claimer}</td><td>{claimTxHash}</td>' +
    ticketAction(ticketId, formatState(bnClaimExpiry)) + '</tr>';


  var bnEther = toEther(bnWei);
  var bnUnitPrice = toUnitPrice(bnWeiPerSatoshi);
  var bnTotalPrice = toTotalPrice(bnEther, bnUnitPrice);

  tr = tr.replace('{ticketId}', ticketId);
  tr = tr.replace('{btcAddr}', formatBtcAddr(bnBtcAddr));
  tr = tr.replace('{numEther}', formatEtherAmount(bnEther));
  tr = tr.replace('{unitPrice}', formatUnitPrice(bnUnitPrice));
  tr = tr.replace('{totalPrice}', formatTotalPrice(bnTotalPrice));
  tr = tr.replace('{claimExpiry}', formatState(bnClaimExpiry));
  // tr = tr.replace('{claimer}', formatClaimer(bnClaimer));
  // tr = tr.replace('{claimTxHash}', formatClaimTx(bnClaimTxHash));

  $('#ticketTable > tbody').append(tr);
}

function ticketAction(ticketId, ticketState) {
  var btnLabel;
  if (ticketState === 'OPEN') {
    btnLabel = 'Reserve';
  }
  else {
    btnLabel = 'Claim';
  }
  return '<td><button class="btn">' + btnLabel + '</button></td>'
}



$(function() {
  if (!gBtcTestnet) {
    $('#ticketContractAddr').text(gTicketContractAddr);

    // tx190 300K
    var txHash = '141e4ea2fa3c9bf9984d03ff081d21555f8ccc7a528326cea96221ca6d476566';
    $('#txHash').val(txHash);

    showTickets();
  }


  $("#appTab a").click(function(e){
    e.preventDefault();
    $(this).tab('show');
  });
});



</script>

</head>

<body>

  <div class="container">
    <div class="logo">
      <img src="./images/ethereum-logo-small.png"/>
    </div>

    <ul class="nav nav-tabs" id="appTab">
      <li role="presentation"><a href="#ticketSection">Tickets</a></li>
      <li role="presentation" class="active"><a href="#claimSection">Claim</a></li>
    </ul>

    <div class="tab-content">

      <div id="ticketSection" class="tab-pane fade">
        <h2>Tickets offering ether for bitcoin
        </h2>

        <table class="table" id="ticketTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ethers</th>
              <th>Unit Price BTC</th>
              <th>Total Price BTC</th>
              <th>Bitcoin address</th>
              <th>Reserved</th>
              <!-- <th>Claimer</th>
              <th>Transaction Hash</th> -->
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="claimSection" class="tab-pane fade in active">
        <h2>Reserve then Claim Ether
        </h2>

        <p class="lead">Ticket contract at <span id="ticketContractAddr"></span></p>

        <div class="row">
          <div class="col-md-6">
            <h3>Ticket</h3>
            <h5>Ether amount: <strong id="numEther"></strong></h5>
            <h5>Total Price BTC: <strong id="totalPrice"></strong></h5>
            <h5>Bitcoin Address: <strong id="btcAddr"></strong></h5>
          </div>
          <div class="col-md-6">
            <h3>Bitcoin Transaction</h3>
            <h5>Ether Fee to Claimer: <strong id="encodedFee"></strong></h5>
            <h5>BTC: <strong id="btcPayment"></strong></h5>
            <h5>Bitcoin Address: <strong id="paymentAddr"></strong></h5>
            <h5>Ether address: <strong id="etherAddr"></strong></h5>
          </div>
        </div>

        <form class="form">
          <fieldset>
            <label for="ticketId">Ticket ID</label>
            <input type="text" class="form-control" id="ticketId"></input>

            <label for="txHash">Bitcoin Transaction Hash</label>
            <input type="text" class="form-control" id="txHash"></input>

            <br>
            <button type="button" class="btn btn-default" onclick="lookup();">Lookup</button>
          </fieldset>
        </form>

        <h3>Claimer</h3>
        <h5>Address: <strong id="claimerAddr"></strong></h5>
        <h5>Expiry: <strong id="claimExpiry"></strong></h5>
        <h5>Bitcoin Transaction Hash: <strong id="claimTxHash"></strong></h5>
        <h5>Claimer will receive ether: <strong id="computedFee"></strong></h5>
        <h5>Claimer needs to provide ether security deposit: <strong id="depositRequired"></strong></h5>
        <button type="button" class="btn" onclick="callContract();">Reserve Ticket</button>

      </div>
    </div>


    <div id="result"></div>

    <div class="footer-logo">
      <img src="./images/ETH_DEV_LOGO_LARGE.svg"/>
    </div>
  </div>

</body>

</html>
