<!DOCTYPE html>
<html lang="en">
<head>
  <title>Ethereum: offer your ether for bitcoin</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/dapp.css">
  <script src="./js/jquery-2.1.3.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <script src="./js/ethBtcSwapAbi.js"></script>

  <script src="./js/bignumber.js"></script>
  <script src="./js/web3.min.js"></script>

<script type="text/javascript">
var web3 = require('web3');
    web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));


var gTicketContractAddr;
var gBtcTestnet;
var gOurBtcAddr;


// gBtcTestnet = true;
if (gBtcTestnet) {
  // gTicketContractAddr = '0xa5bbd4e59bdc2c17e52e7056afe43ba9f52462f2';
  //
  // gOurBtcAddr = 'mvBWJFv8Uc84YEyZKBm8HZQ7qrvmBiH7zR';
}
else {
  gTicketContractAddr = '0x26c95ad29af97db07cfa8087bebf804d6411c1a0';

  gOurBtcAddr = '61cf5af7bb84348df3fd695672e53c7d5b3f3db9'  // tx190 of block300K
}

var gFromAccount = '0xcd2a3d9f938e13cd947ec05abc7fe734df8dd826';


function callContract() {
  // TODO ticket Abi
  console.log('@@@ in callContract')
  console.log('@@@ externalEthBtcSwapAbi: ', externalEthBtcSwapAbi)
  console.log('@@@ gFromAccount: ', gFromAccount)


  var callOnly;
  callOnly = true;  // if commented, it will do sendTransaction


  // TODO don't forget to update the ABI
  var bethAddress = gTicketContractAddr;
  var abiToUse;
  abiToUse = externalEthBtcSwapAbi;


  var TicketContract = web3.eth.contract(abiToUse);
  var contract = TicketContract.at(bethAddress);
  console.log('@@@@ contract: ', contract)


  var btcAddr = $('#btcAddr').val();
  var numWei = $('#numWei').val();
  var weiPerSatoshi = $('#weiPerSatoshi').val();


  if (callOnly) {
    console.log('@@@@ callOnly')
    var startTime = Date.now();


    var objParam = {from:gFromAccount, gas: 3000000};
    var res = contract.createTicket.call(btcAddr, numWei, weiPerSatoshi, objParam);


    var endTime = Date.now();
    var durationSec = (endTime - startTime) / 1000;
    console.log('@@@@ call res: ', res, ' duration: ', durationSec)
    document.getElementById('result').innerText = res.toString(10) + "    " + durationSec+ "secs";
    return;
  }


  // var startTime = Date.now();
  // var objParam = {from:gFromAccount, gas: 3000000-10, gasPrice: 0};
  //
  // contract.createTicket.sendTransaction(btcAddr, numWei, weiPerSatoshi, objParam);
  // document.getElementById('result').innerText = 'Ethereum transaction is in progress...'
}


$(function() {
  if (!gBtcTestnet) {
    $('#ticketContractAddr').text(gTicketContractAddr);

    // tx190 300K
    $('#btcAddr').val(gOurBtcAddr)
    $('#numWei').val(web3.toWei(1, 'ether'));
    $('#weiPerSatoshi').val(38461538461);  // TODO
  }
});



</script>

</head>

<body>

  <div class="container">
    <div class="logo">
      <img src="./images/ethereum-logo-small.png"/>
    </div>

    <h2>Offer your ether for bitcoin
    </h2>

    <p class="lead">Ticket contract at <span id="ticketContractAddr"></span></p>


    <form>
      <div class="form-group">
        <label for="btcAddr">Your Bitcoin address</label>
        <input type="text" class="form-control" id="btcAddr" size="30" maxlength="30"></input>

        <label for="numWei">Number of ethers</label>
        <input type="text" class="form-control" id="numWei" size="30" maxlength="30"></input>

        <label for="weiPerSatoshi">Wei per Satoshi</label>
        <input type="text" class="form-control" id="weiPerSatoshi" size="30" maxlength="30"></input>
      </div>
      <br><br>
      <button type="button" class="btn btn-default" onclick="callContract();">Submit offer</button>
    </form>


    <div id="result"></div>

    <div class="footer-logo">
      <img src="./images/ETH_DEV_LOGO_LARGE.svg"/>
    </div>
  </div>

</body>

</html>
