<!DOCTYPE html>
<html lang="en">
<head>
  <title>Ethereum: offer your ether for bitcoin</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/dapp.css">
  <script src="./js/jquery-2.1.3.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <script src="./js/bignumber.js"></script>
  <script src="./js/web3.min.js"></script>

  <script src="./js/bs58check.js"></script>

  <script src="./js/ethBtcSwapAbi.js"></script>
  <script src="./js/shared.js"></script>

<script type="text/javascript">
var web3 = require('web3');
    web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));


function decodeBase58Check(btcAddr) {
  var byteArrayData = bs58check.decode(btcAddr);

  var ret = "",
    i = 1,  // skip the Bitcoin "version" prefix
    len = byteArrayData.length;

  while (i < len) {
    var a = byteArrayData[i];
    var h = a.toString(16);
    if (a < 10) {
      h = "0" + h;
    }
    ret += h;
    i++;
  }

  return ret;
}

function callContract() {
  // TODO ticket Abi
  console.log('@@@ in callContract')
  console.log('@@@ gFromAccount: ', gFromAccount)


  var callOnly;
  // callOnly = true;  // if commented, it will do sendTransaction

  var btcPrice = $('#btcPrice').val();

  // these are passed to contract
  var addrHex;
  try {
    addrHex = '0x' + decodeBase58Check($('#btcAddr').val().trim());
  }
  catch (err) {
    document.getElementById('result').innerText = 'Bad Bitcoin address: ' + err.message;
    return;
  }
  var numWei = web3.toWei($('#numWei').val(), 'ether');
  var weiPerSatoshi = new BigNumber(numWei).div(SATOSHI_PER_BTC.mul(btcPrice)).round(0);
  console.log('@@@@ addrHex: ', addrHex, ' numWei: ', numWei, ' weiPerSatoshi: ', weiPerSatoshi.toString(10));


  // TODO confirmation to deposit ether, from account, gasprice
  var objParam = {value: numWei, from:gFromAccount, gas: 500000};

  if (callOnly) {
    console.log('@@@@ callOnly')
    var startTime = Date.now();


    var res = gContract.createTicket.call(addrHex, numWei, weiPerSatoshi, objParam);


    var endTime = Date.now();
    var durationSec = (endTime - startTime) / 1000;
    console.log('@@@@ call res: ', res, ' duration: ', durationSec)
    document.getElementById('result').innerText = res.toString(10) + "    " + durationSec+ "secs";
    return;
  }


  var rvalFilter = gContract.ticketEvent({ ticketId: 0 });
  rvalFilter.watch(function(err, res) {
    if (err) {
      console.log('@@@ rvalFilter err: ', err)
      return;
    }

    console.log('@@@ rvalFilter res: ', res)

    var eventArgs = res.args;
    if (eventArgs.rval.toNumber() > 0) {
      document.getElementById('result').innerText = 'SUCCESS Ticket created';
    }
    else {
      document.getElementById('result').innerText = 'Failed. You need to send the ethers to the Ticket contract';
    }

    rvalFilter.stopWatching();
  });

  // var startTime = Date.now();
  //
  gContract.createTicket.sendTransaction(addrHex, numWei, weiPerSatoshi, objParam, function(err, result) {
    if (err) {
      console.log('@@@ err: ', err)
      return;
    }

    // result is a txhash
    console.log('@@@ createTicket result: ', result)

  });
  document.getElementById('result').innerText = 'Ethereum transaction is in progress...'
}


$(function() {
  if (!gBtcTestnet) {
    $('#ticketContractAddr').text(gTicketContractAddr);

    // tx190 300K
    $('#btcAddr').val(gOurBtcAddr);

    var etherAmount = formatEtherAmount(web3.toWei(1, 'ether'));
    $('#numWei').val(etherAmount);

    var btcPrice = '0.26';
    $('#btcPrice').val(btcPrice);


    $('#numWei').keyup(computeUnitPrice);
    $('#btcPrice').keyup(computeUnitPrice);


    // var unitPrice = formatUnitPrice(38461538462);
    // $('#unitPrice').val(unitPrice);  // TODO
  }
});

function computeUnitPrice() {
  var bnWei = new BigNumber($('#numWei').val());
  var bnBtcPrice = new BigNumber($('#btcPrice').val());

  var unitPrice = bnBtcPrice.div(bnWei);
  $('#unitPrice').val(unitPrice)
}



</script>

</head>

<body>

  <div class="container">
    <div class="logo">
      <img src="./images/ethereum-logo-small.png"/>
    </div>

    <h2>Offer your ether for bitcoin
    </h2>

    <p class="lead">Ticket contract at <span id="ticketContractAddr"></span></p>

    <form class="form">
      <fieldset>
        <label for="btcAddr">Your Bitcoin address</label>
        <input type="text" class="form-control" id="btcAddr"></input>

        <label for="numWei">Number of ethers</label>
        <input type="text" class="form-control" id="numWei"></input>

        <label for="btcPrice">Bitcoin Price</label>
        <input type="text" class="form-control" id="btcPrice"></input>

        <label for="unitPrice">Unit Price</label>
        <input type="text" readonly class="form-control" id="unitPrice"></input>

        <br>
        <button type="button" class="btn btn-default" onclick="callContract();">Submit offer</button>
      </fieldset>
    </form>


    <div id="result"></div>

    <div class="footer-logo">
      <img src="./images/ETH_DEV_LOGO_LARGE.svg"/>
    </div>
  </div>

</body>

</html>
