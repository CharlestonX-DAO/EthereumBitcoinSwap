<!DOCTYPE html>
<html lang="en">
<head>
  <title>Ethereum: offer your ether for bitcoin</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/dapp.css">
  <script src="./js/jquery-2.1.3.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <script src="./js/bignumber.js"></script>
  <script src="./js/web3.min.js"></script>

  <script src="./js/ethBtcSwapAbi.js"></script>
  <script src="./js/shared.js"></script>

<script type="text/javascript">
var web3 = require('web3');
    web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));


function callContract() {
  // TODO ticket Abi
  console.log('@@@ in callContract')
  console.log('@@@ externalEthBtcSwapAbi: ', externalEthBtcSwapAbi)
  console.log('@@@ gFromAccount: ', gFromAccount)


  // TODO don't forget to update the ABI
  var bethAddress = gTicketContractAddr;
  var abiToUse = externalEthBtcSwapAbi;


  var TicketContract = web3.eth.contract(abiToUse);
  var contract = TicketContract.at(bethAddress);
  console.log('@@@@ contract: ', contract)


  var btcAddr = '0x' + $('#btcAddr').val();
  var numWei = $('#numWei').val();
  var weiPerSatoshi = $('#weiPerSatoshi').val();


  // TODO confirmation to deposit ether, from account, gasprice
  var objParam = {from:gFromAccount, gas: 500000};

  var ticketArr = contract.getOpenTickets.call(1, 40, objParam);  // TODO may need objParam

  writeTable(ticketArr);
}


var TICKET_FIELDS = 7;
function writeTable(ticketArr) {
  var len = ticketArr.length;
  for (var i=0; i < len; i+= TICKET_FIELDS) {
    writeRow(ticketArr, i);
  }
}


function writeRow(ticketArr, index) {
  var ticketId = ticketArr[index + 0].toString(10);
  var btcAddr = formatHash(ticketArr[index + 1]);
  var bnWei = ticketArr[index + 2];
  var weiPerSatoshi = ticketArr[index + 3].toString(10);

  var claimExpiry = ticketArr[index + 4].toString(10)
  var claimer = formatHash(ticketArr[index + 5])
  var bnClaimTxHash = ticketArr[index + 6]

  var tr = '<tr><td>{ticketId}</td><td>{numWei}</td><td>{weiPerSatoshi}</td>' +
    '<td>{totalPrice}</td><td>{btcAddr}</td><td>{claimExpiry}</td>' +
    '<td>{claimer}</td><td>{claimTxHash}</td>' +
    ticketAction(ticketId, claimExpiry) + '</tr>';

  tr = tr.replace('{ticketId}', ticketId);
  tr = tr.replace('{btcAddr}', btcAddr);

  var bnEtherAmount = formatEtherAmount(bnWei);
  tr = tr.replace('{numWei}', bnEtherAmount);

  var bnUnitPrice = formatUnitPrice(weiPerSatoshi);
  tr = tr.replace('{weiPerSatoshi}', bnUnitPrice);

  tr = tr.replace('{totalPrice}', bnEtherAmount.mul(bnUnitPrice));
  tr = tr.replace('{claimExpiry}', formatState(claimExpiry));
  tr = tr.replace('{claimer}', formatClaimer(claimer));
  tr = tr.replace('{claimTxHash}', formatClaimTx(bnClaimTxHash));

  $('#ticketTable > tbody').append(tr);
}


$(function() {
  if (!gBtcTestnet) {
    // $('#ticketContractAddr').text(gTicketContractAddr);

    callContract()
  }
});


function ticketAction(ticketId, claimExpiry) {
  var btnLabel;
  if (isTicketAvailable(claimExpiry)) {
    btnLabel = 'Reserve';
  }
  else {
    btnLabel = 'Claim';
  }
  return '<td><button class="btn">' + btnLabel + '</button></td>'
}

function formatState(expiry) {
  if (isTicketAvailable(expiry)) {
    return 'OPEN';
  }
  return expiry;
}

function formatClaimer(claimer) {
  return claimer === '0' ? '-' : claimer;
}

var TWO_POW_256 = new BigNumber(2).pow(256);
function formatClaimTx(bnClaimTxHash) {
  return bnClaimTxHash.eq(0) ? '-' : formatHash(bnClaimTxHash);
}

// http://stackoverflow.com/questions/3417183/modulo-of-negative-numbers/3417242#3417242
function formatHash(bn) {
  return bn.mod(TWO_POW_256).add(TWO_POW_256).mod(TWO_POW_256).toString(16);
}


function isTicketAvailable(claimExpiry) {
    // TODO: check block timestamp
    return claimExpiry === '1';
}


</script>

</head>

<body>

  <div class="container">
    <div class="logo">
      <img src="./images/ethereum-logo-small.png"/>
    </div>

    <h2>Tickets offering ether for bitcoin
    </h2>

    <table class="table" id="ticketTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Number of ether</th>
          <th>Unit Price BTC</th>
          <th>Total Price BTC</th>
          <th>Bitcoin address</th>
          <th>Reserved</th>
          <th>Claimer</th>
          <th>Transaction Hash</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>


    <div id="result"></div>

    <div class="footer-logo">
      <img src="./images/ETH_DEV_LOGO_LARGE.svg"/>
    </div>
  </div>

</body>

</html>
